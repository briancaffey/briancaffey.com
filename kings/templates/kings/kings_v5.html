{% load staticfiles %}

<!doctype html>
<html>
<head>
  <title>King's Encounter</title>

  <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.js"></script>
  <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/ui-lightness/jquery-ui.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/modal.css' %}">

</head>

<body style="padding-top:30px;">

      <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="{% url 'kings:kings' %}">ğŸ‘‘&nbsp;&nbsp;King's Encounter âš”</a>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">

              <li style="display:none;" class="stat"><a>â¤ï¸ âœ–ï¸ <span class="health"></span></a></li>
              <li style="display:none;" class="stat"><a>ğŸ’ âœ–ï¸ <span class="diamonds"></span></a></li>
              <li style="display:none;" class="stat"><a>ğŸ“œ âœ–ï¸ <span class="scrolls"></span></a></li>
              <li style="display:none;" class="stat"><a>ğŸ— âœ–ï¸ <span class="keys"></span></a></li>
              <li style="display:none;" class="stat"><a>â³&nbsp;&nbsp;<span class="clock">0 : 00</span></a></li>
              <li style="display:none;" class="stat"><a>Scene: <span class="scene"></span></a></li>
              <li style="display:none;" class="stat"><a>Pos: <span class="pos"></span></a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="#music" type="button" data-toggle="modal" data-target="#myModal-music">ğŸ”Š</a></li>
              <li><a>Guest</a></li>
              <li><a href="{% url 'home:home' %}">Exit</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </nav>

      <div class="modal fade" id="myModal-music" role="dialog">
        <div class="modal-dialog">
          <!-- Modal content-->
          <div class="modal-content">
            <div style="text-align:center;" class="modal-body">
              <h1>ğŸ»ğŸ¹ğŸ¶</h1>
              <audio loop="loop" autoplay="true" audio="" controls="controls">
                    <source src="{% static 'music/plirwin.ogg' %}">
                    <embed type="application/x-shockwave-flash" src="http://www.google.com/reader/ui/3523697345-audio-player.swf" quality="best" flashvars="audioUrl=http://www.contemplator.com/mp3/plirwin.mp3" width="500" height="27">
                    </audio>
            </div>
            <div class="modal-footer">
              <div class="pull-left">Source: <a href="http://www.contemplator.com/">contemplator.com</a></div>
              <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
            </div>
          </div>
        </div>
      </div>



  <div style="background-color:" class="container">
    <div class="row">

      </div>
      <span id="welcomeJumbo">
      <div style="padding-top:40px;" class="row">
<div style="text-align:center;" class="jumbotron" >
  <h1>ğŸ‘‘âš”ğŸ°ğŸ‰â¤ï¸<br />Welcome to King's Encounter!</h1>
  <br />
  <p>Prepare yourself! A journey awaits...</p>
  <br />
<p>choose your character</p>
  <form action="." class="form-contorl input-lg">
    <select class="choose_avatar" name="choose_avatar">
      <option value="ğŸ˜ƒ">&nbsp;&nbsp;ğŸ˜ƒ&nbsp;&nbsp;</option>
      <option value="ğŸ‘¦ğŸ¼">&nbsp;&nbsp;ğŸ‘¦ğŸ¼&nbsp;&nbsp;</option>
      <option value="ğŸ‘¨ğŸ»">&nbsp;&nbsp;ğŸ‘¨ğŸ»&nbsp;&nbsp;</option>
      <option value="ğŸ‘©ğŸ»">&nbsp;&nbsp;ğŸ‘©ğŸ»&nbsp;&nbsp;</option>
      <option value="ğŸ‘©ğŸ½">&nbsp;&nbsp;ğŸ‘©ğŸ½&nbsp;&nbsp;</option>
    </select>
    <br /><br />
  </form>
  <a id="start_btn" class="btn btn-success btn-lg togglePlay" href="#start" class="togglePlay">Begin!</a>
</div>
</div>
<div style="text-align:center;" class="row">
<div class="col-md-4"><h2>â¬†ï¸â¬…ï¸â¬‡ï¸â¡ï¸<br />Walk with W, A, S and D.</h2><p>You can also use the arrow keys</p></div>
<div class="col-md-4"><h2>ğŸ²ğŸ˜±ğŸ˜²ğŸ’€<br />Beware of dragons.</h2><p>Crossing paths with dragons will decrease your health.</p></div>
<div class="col-md-4"><h2>ğŸ“œğŸ‘“ğŸ’¡âœ…<br />Collect scrolls.</h2><p>Scrolls contain hints and important knowledge.</p></div>
</div>

</span>

<div style="padding-top:40px;" class="col-md-10">
<div style="align:center;" class="canvas"><table style="font-size:3.5em;" class="grid"><tbody id="scene"></tbody></table>

</div>
</div>
</div>

<!-- Dialogue Modal -->
<div id="myModal" class="dialogue-modal">
  <!-- Modal Content -->
  <div   class="modal-content">
    <span class="close">&times;</span>
    <p id="dialogue-title" style="text-align:center; font-size:6em"></p>
    <p id="dialogue-body" style="font-size:3em;"></p>
  </div>
</div>

<script>
$('#start_btn').focus();
var modal = document.getElementById('myModal');
var span = document.getElementsByClassName("close")[0];
var showModal = function() {
    modal.style.display = "block";
}

span.onclick = function() {
    modal.style.display = "none";
}
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
</script>

</div>
</body>

</html>

<script src="{% static 'js/items.js' %}" type="text/javascript" ></script>

<script>

$("#start_btn").click(function(e){
  e.preventDefault()
  $.ajax({
    url: '/api/kings/20/',
    method: "GET",
    data: {},
    success: function(data){
      window.scene = data['game']['game']
    },
    error: function(XMLHttpRequest, textStatus, errorThrown) {
      alert("some error " + String(errorThrown) + String(textStatus) + String(XMLHttpRequest.responseText));
    }
  });
});


// var scene;
//
// var scenes_string = "{{ game.game | escapejs }}"
//
// scenes = JSON.parseJSON(scenes)





var player = {
 avatar: null,
 current: [1,2],
 health: 1,
 diamonds: 0,
 scrolls: 0,
 keys: 0,
 emoji: 'ğŸ˜€',
 sword: false,
 orb: false,
 card: false,
 nut: false,
};
//
// function checkHealth(){
//   if (player.health < 1){
//     player.emoji = 'ğŸ˜µ';
//     playerDie();
//   } else {
//   player.emoji = player.avatar;
//   }
// }
//
// // var playerDie = function(){
// //
// // }
//
// // function populateEnemies(){
// //   scenes[current_scene].map[dragon.current[0]][dragon.current[1]] = dragon;
// // };
//
function placePlayer(){
     scene[player.current[0]][player.current[1]] = player;
   }

function buildScene(){
  $("tbody tr").remove();
  // if (scenes[current_scene].dragon){
  //   populateEnemies();
  // };
  placePlayer();
  for (row in scene){
    var current = $('.grid tbody').append("<tr row="+row+"></tr>")
    for (square in scene[row]){
      $('tr[row='+ row +']').append("<td col="+square+">"+scene[row][square].emoji+"</td>")
    }
  }
};



function checkSquare(square){
  if (square == heart){
    player.health += 1;
  }
  if (square == diamond){
    player.diamonds += 1;
  }
  if (square == scroll){
    player.scrolls += 1;
  }
  if (square == nut){
    player.nut = true;
  }
  if (square == key){
    player.keys += 1;
  }
  if (square == owl){
    box(owl.emoji, "HOO! HOO!");
  }
  if (square == crown){
    box(crown.emoji + ' ğŸ’Œ', "I have already heard about the great deed you did for my sister and the royal family. News travels quickly in our kingdom. I would like to invite you to a royal banquet this evening, please take this envelope and come back to the castle this evening. You may want to go explore the village before the banquet starts, you are sure to meet some interesting folk there. It's just beyond the castle. Thank you again.")
  }
  if (square == orb){
    player.orb = true;
  }
  if (square == squirrle){
    if (!player.nut){
      box(squirrle.emoji, "I love nuts! If you see any nuts would you mind bringing them to me! If you do I might be able to do you a small favor...");
    } else {
      box(nut.emoji + "  " + squirrle.emoji + "  ğŸ—", "Wow!! Thank you soo much! Chestnuts are my favorite! I want you to have this ribbon, I think it belongs to a wealthy family just outside of the village. They would be very grateful to have it.")
    }
  }
  if (square == woman){
    if (player.orb){
      if (!player.card){
      box(woman.emoji + " " + card.emoji, 'Oh my goodness!! The sacred orb! What a brave young man! For your bravery and courage I would like to give you something... here is a pass to the royal castle ğŸƒ');
      player.card = true;
    } else {
      box(woman.emoji, 'Hurry along to the castle, it is just beyong the village up ahead. I will stay here and enjoy this fountain for now.');
    }

    } else {
    box(woman.emoji, 'Oh would you take this sword and slay that beastly dragon! He has stolen the regal orb! I need it!!! Thank you!');
    }
  }
  if (square == sword){
    player.sword = true;
    square = open_;
    box(sword.emoji, 'Press SPACE to use you sword!')
  }
  if (square.exitway){
    var entry_point = [square.entry[0],square.entry[1]];
    player.current = entry_point;
    current_scene = square.next;
    buildScene();
  }
}
//
// function checkChange(step){
//   console.log(scenes[3].map[2][11].entry, step)
// }
//
// var box = function(header, text){
//   $("#dialogue-title").text(header)
//   $("#dialogue-body").text(text)
//   showModal();
// }
//
//
// function updateStats(){
//   $(".health").text(player.health)
//   $(".diamonds").text(player.diamonds)
//   $(".scrolls").text(player.scrolls)
//   $(".keys").text(player.keys)
//   $(".scene").text(current_scene)
//   $(".pos").text(player.current)
// }
//
// updateStats();
//
function start(){


function move(the_next_square, axis, operation){
  if (the_next_square.exitway){
    scenes[current_scene].map[player.current[0]][player.current[1]] = open_;
  }
  if (!the_next_square.wall && !the_next_square.exitway){
    scene[player.current[0]][player.current[1]] = things.blank;
    if (operation == "+"){
      if (axis == 0){
        player.current[0] += 1;
      } else{
        player.current[1] += 1;
      }
    } else {
      if (axis == 0){
        player.current[0] -= 1;
      } else {
        player.current[1] -= 1;
      }
    }
  }
}
//
//
//
var pushKeys = window.addEventListener("keydown", function(event) {
if (modal.style.display == 'block'){
  // console.log('close modal');
  if (event.keyCode == 32){
    event.preventDefault();
    modal.style.display = 'none';
    }
  } else {
  if (event.keyCode == 40 || event.keyCode == 83){
    event.preventDefault();
    var current = player.current[0];
    var next_ = current + 1;
    var next_square = scene[next_][player.current[1]];
    move(next_square, 0, "+");
    checkSquare(next_square);
    }

  if (event.keyCode == 38 || event.keyCode == 87){
    event.preventDefault();
    var current = player.current[0];
    var next_ = current - 1;
    var next_square = scene[next_][player.current[1]];
    move(next_square, 0, "-");
    checkSquare(next_square);
    }

  if (event.keyCode == 37 || event.keyCode == 65){

    event.preventDefault();
    var current = player.current[1];
    var next_ = current - 1;
    var next_square = scene[player.current[0]][next_];
    move(next_square, 1, "-");
    checkSquare(next_square);
    }

  if (event.keyCode == 39 || event.keyCode == 68){
    event.preventDefault();
    var current = player.current[1];
    var next_ = current + 1;
    var next_square = scene[player.current[0]][next_];
    move(next_square, 1, "+");
    checkSquare(next_square);
    }

  if (event.keyCode == 32){
    event.preventDefault();
    if (player.sword){
      var current = player.current;
      var attack_squares = [scene[current[0]+1][current[1]],
                            scene[current[0]-1][current[1]],
                            scene[current[0]][current[1]+1],
                            scene[current[0]][current[1]-1]]
      for (square in attack_squares){
        if (attack_squares[square] == dragon){
          dragon.health -= 1;
          checkDragonHealth();
        }
      }
    }
  }
}

  buildScene();
  // checkHealth();
  // updateStats();

});
// //dragon direction
// var direction = -1;
//
// function checkDragonHealth(){
//   if (dragon.health < 0){
//     scene[dragon.current[0]][dragon.current[1]] = orb;
//     scenes[current_scene].dragon = false;
//
//     buildScene();
//
//   }
// }
//
// var dragonMove = function(){
//   if (scenes[current_scene].dragon == true){
//     var dragon_pos = dragon.current;
//     var current_ = dragon.current[1];
//     var next_ = current_ + 1;
//     var next_dragon = scene[next_][player.current[1]];
//     scene[dragon.current[0]][dragon.current[1]] = open_;
//     if (dragon.current[0] == 1){
//       direction = 1;
//     } else if (dragon.current[0] == 7){
//       direction = -1;
//     };
//
//     dragon.current[0] += direction;
//
//     if (dragon.current[0] == player.current[0] && dragon.current[1] == player.current[1]){
//       player.health -= 1;
//       updateStats();
//     }
//     buildScene();
//   }
// }
//
// var enemy1 = function(){ setInterval(dragonMove, 350);};
// enemy1();
// buildScene();
//
};

// // var map_ = null;
// function updateScene(){
//   // scene_data = scenes[current_scene]
//   map_ = scene_data.map;
// }

var total_seconds = 0;
var startClock = function(){setInterval(function updateClock(){
  total_seconds += 1;
  var pad_zero;
  if (total_seconds % 60 < 10) {
    pad_zero = '0';
  } else {
    pad_zero = '';
  }
  var time = (Math.ceil(total_seconds/60 - 1)) +' : ' + pad_zero + (total_seconds % 60);
  $(".clock").text(time)
}, 1000);
};

$('.togglePlay').click(function(){
  var avatar = $(".choose_avatar").val();
  player.avatar = avatar;
  // start();
  startClock();
  $(this).text('Stop');
  $('#welcomeJumbo').hide();
  $('.stat').show();

})

$(".choose_avatar").change(function (){
    player.emoji = $(this).val();
});



</script>
