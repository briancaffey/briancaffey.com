{% load staticfiles %}

<!doctype html>
<html>
<head>
  <title>King's Encounter</title>
  <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.js"></script>
  <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/ui-lightness/jquery-ui.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="{% static 'css/base.css' %}">
  <link rel="stylesheet" href="{% static 'css/modal.css' %}">
</head>

<body style="padding-top:30px;">

{% include 'kings/kings_nav.html' %}

  <div style="background-color:" class="container">
    <div class="row">
    </div>
      <span id="welcomeJumbo">
      <div style="padding-top:40px;" class="row">

        <div style="text-align:center;" class="jumbotron" >
          <h1>üëë‚öîüè∞üêâ‚ù§Ô∏è<br />Design your very own adventure!</h1>
          <br />
          <p>Build your onw world and share with your friends!</p>
          <br />
          <a id="start_btn" class="btn btn-success btn-lg togglePlay" href="#start" class="togglePlay">Get Started!</a>
        </div>
      </div>
      <div style="text-align:center;" class="row">
        <div class="col-md-4"><h2>‚¨ÜÔ∏è‚¨ÖÔ∏è‚¨áÔ∏è‚û°Ô∏è<br />Move the red square with W, A, S and D.</h2><p>You can also use the arrow keys</p></div>
        <div class="col-md-4"><h2>·öÄ Spacebar<br />.</h2><p>Crossing paths with dragons will decrease your health.</p></div>
        <div class="col-md-4"><h2>üìúüëìüí°‚úÖ<br />Collect scrolls.</h2><p>Scrolls contain hints and important knowledge.</p></div>
      </div>
    </span>
    <div style="padding-top:40px;" class="col-md-10">
      <div style="align:center;" class="canvas"><table style="font-size:3.5em;" class="grid"><tbody id="scene"></tbody></table>
      </div>
    </div>
  </div>

  <!-- if (event.keyCode == 81){
    $('#myModal-q').modal('toggle');
  } -->

  <div class="modal fade" id="myModal-saved" role="dialog">
    <div class="modal-dialog">
      <!-- Modal content-->
      <div class="modal-content">
        <div style="text-align:center;" class="modal-body">
          <h1>Your game has been saved!</h1>
          <p>You your game is available here: <a id="new_game_link" href="">link</a></p>

          <br /><br />
          <p>create an account to manage and share your games</p>
          <button class="btn btn-success" href="">Create account</button>
        </div>


          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>

      </div>
    </div>
  </div>





  <div class="modal fade" id="myModal-q" role="dialog">
    <div class="modal-dialog">
      <!-- Modal content-->
      <div class="modal-content">
        <div style="text-align:center;" class="modal-body">
          <h1>Controls</h1>
          <h4>Press <b>Q</b> to toggle controls</h4>
          <h4>Press <b>M</b> to toggle emoji selector menu</h4>
          <h4>Press <b>P</b> to add properties to the selected square</h4>
          <h4>Press <b>W, A, S and D</b> to move the pointers</h4>
        </div>


          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>

      </div>
    </div>
  </div>




  <div id="blockInfoModal" class="dialogue-modal">
    <div class="modal-content">
      <span id="blockInfoclose" class="close">&times;</span>
      <p id="dialogue-title" style="text-align:center; font-size:6em">Choose an emoji üëâ <span id="current_emoji"></span></p>
      <p id="blockInfo" style="font-size:3em;"></p>
    </div>
  </div>

<div id="myModal" class="dialogue-modal">
  <div   class="modal-content">
    <span id="myModalclose" class="close">&times;</span>
    <p id="dialogue-title" style="text-align:center; font-size:6em">Choose an emoji üëâ <span id="current_emoji"></span></p>
    <p id="emojis" style="font-size:3em;"></p>
  </div>
</div>

<script src="{% static 'js/items.js' %}" type="text/javascript" ></script>

<script>

function isConsoleOpen() {
  var startTime = new Date();
  debugger;
  var endTime = new Date();

  return endTime - startTime > 100;
}

$(function() {
  $(window).resize(function() {
    if(isConsoleOpen()) {
        alert("You're one sneaky dude, aren't you ?")
    }
  });
});



$('.togglePlay').click(function(){
  $('#welcomeJumbo').hide();
  buildScene();
})

var selected = things.tent
$("#current_emoji").text(selected.emoji);
var current_scene = "first"
var new_scene = function(){}


var scenes = {
                'title':null,
                'user':null,
                'current_scene':'first',
                'scenes':{
                  'first':
                    {'grid':
                      {0:[things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree,things.tree,things.tree,things.tree,things.tree,],
                       1:[things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree,things.tree,things.tree,things.tree,things.tree,],
                       2:[things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree,things.tree,things.tree,things.tree,things.tree,],
                       3:[things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree,things.tree,things.tree,things.tree,things.tree,],
                       4:[things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree,things.tree,things.tree,things.tree,things.tree,],
                       5:[things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree,things.tree,things.tree,things.tree,things.tree,],
                       6:[things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree,things.tree,things.tree,things.tree,things.tree,],
                       7:[things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree,things.tree,things.tree,things.tree,things.tree,],
                       8:[things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree,things.tree,things.tree,things.tree,things.tree,],
                       9:[things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree, things.tree,things.tree,things.tree,things.tree,things.tree,things.tree,]
                  },
                }
              }
            }

var pointer = {
     current: [0,0],
  }

var emoji_pointer = {
  current: [0,0],
}

function buildEmojiMenu(){
    $('#emojis tr').remove();
    for (row in emoji_map){
      var current = $('#emojis').append("<tr row="+row+"></tr>")
      for (square in emoji_map[row]){
        if (row == emoji_pointer.current[0] && square == emoji_pointer.current[1]){
          $('tr[row='+ row +']').append("<td class='emoji-choice' style='background-color: #ffb2b2' col="+square+">"+emoji_map[row][square].emoji+"</td>")
            } else {
          $('tr[row='+ row +']').append("<td class='emoji-choice' col="+square+">"+emoji_map[row][square].emoji+"</td>")
        }
      }
    }
};

var scene = null;
function buildScene(){
  scene = scenes['scenes'][current_scene].grid;
  $("tbody tr").remove();
  for (row in scene){
    var current = $('.grid tbody').append("<tr class='emoji_row' row="+row+"></tr>")
    for (square in scene[row]){
      if (row == pointer.current[0] && square == pointer.current[1]){
        $('tr[row='+ row +'].emoji_row').append("<td class='emojiblock'  name='" + scene[row][square].name + "' style='background-color: #ffb2b2' row=" + row + " col="+square+">"+scene[row][square].emoji+"</td>")
          } else {
        $('tr[row='+ row +'].emoji_row').append("<td class='emojiblock' name='" + scene[row][square].name + "' row=" + row + " col="+square+">"+scene[row][square].emoji+"</td>")
      }
    }
  }
};

function updateSquare(){
  var map_x = pointer.current[0]
  var map_y = pointer.current[1]
  scenes['scenes'][current_scene].grid[map_x][map_y] = selected
}

function showBlockInfo(block){
  $("#blockInfo tr").remove();
  showBlockInfoModal();
  $("#blockInfo").append("<p>This emoji is " + block.emoji + ".</p>")
}

$(".grid tbody").on("click", "tr td", function() {
  var row = $(this).attr('row')
  var col = $(this).attr('col')
  showBlockInfo(scene[row][col]);
  $("#dialogue-title").text(scene[row][col].emoji)

});

var pushKeys = window.addEventListener("keydown", function(event) {
  if (event.keyCode == 81){
    $('#myModal-q').modal('toggle');
  }
 if (modal.style.display == 'block'){
   if (event.keyCode == 40 || event.keyCode == 83){
     event.preventDefault();
     emoji_pointer.current[0]++
     updateEmojiMenu()
     }
   if (event.keyCode == 38 || event.keyCode == 87){
     event.preventDefault();
     emoji_pointer.current[0]--
     updateEmojiMenu()
     }
   if (event.keyCode == 37 || event.keyCode == 65){
     event.preventDefault();
     emoji_pointer.current[1]--
     updateEmojiMenu()
     }
   if (event.keyCode == 39 || event.keyCode == 68){
     event.preventDefault();
     emoji_pointer.current[1]++
     updateEmojiMenu()
     }
   // console.log('close modal');
   if (event.keyCode == 32){
     event.preventDefault();
     modal.style.display = 'none';
   }
   buildEmojiMenu();
 }else {
   if (event.keyCode == 40 || event.keyCode == 83){
     event.preventDefault();
     pointer.current[0]++
     }
   if (event.keyCode == 38 || event.keyCode == 87){
     event.preventDefault();
     pointer.current[0]--
     }
   if (event.keyCode == 37 || event.keyCode == 65){
     event.preventDefault();
     pointer.current[1]--
     }
   if (event.keyCode == 39 || event.keyCode == 68){
     event.preventDefault();
     pointer.current[1]++
     }
   if (event.keyCode == 77){
     event.preventDefault();
     updateSquare()
  }
    if (event.keyCode == 32){
      event.preventDefault();
       showModal();
       buildEmojiMenu();
    }
  }
  buildScene();
});

function updateEmojiMenu(){
  selected = emoji_map[emoji_pointer.current[0]][emoji_pointer.current[1]]
  $("#current_emoji").text(selected.emoji);
}

  var showBlockInfoModal = function() {
      blockInfoModal.style.display = "block";
  }

 var showModal = function() {
     modal.style.display = "block";
 }

$(".emoji-choice").click(function(){
  var id = $(this).attr('id')
  selected = things[id]
  $("#current_emoji").text(selected.emoji);
})

$("#save-level").click(function(event){
  event.preventDefault();


  $.ajaxSetup({
       beforeSend: function(xhr, settings) {
           function getCookie(name) {
               var cookieValue = null;
               if (document.cookie && document.cookie != '') {
                   var cookies = document.cookie.split(';');
                   for (var i = 0; i < cookies.length; i++) {
                       var cookie = jQuery.trim(cookies[i]);
                       // Does this cookie string begin with the name we want?
                       if (cookie.substring(0, name.length + 1) == (name + '=')) {
                           cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                           break;
                       }
                   }
               }
               return cookieValue;
           }
           if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
               // Only send the token to relative URLs i.e. locally.
               xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
           }
       }
  });

  if (window.game_id == null){
  // POST to create new game if it has not yet been saved
  $.ajax({
    type : "POST",
    url : "/api/kings/save/",
    csrfmiddlewaretoken: "{{ csrf_token }}",
    data : JSON.stringify({game:scenes, id:false}),
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    success: function(data){
        console.log(data["id"])
        window.game_id = data["id"]
        window.APIUpdateURL = "/api/kings/"+String(window.game_id)+"/update/"
        console.log(data)
        var pathArray = location.href.split( '/' );
        var protocol = pathArray[0];
        var host = pathArray[2];
        var url = protocol + '//' + host;
        $('#myModal-saved').attr('href',url);
        $('#myModal-saved').text(url);
        $('#myModal-saved').toggle();

        history.pushState(scenes, "", "/kings/game/"+String(game_id)+"/");
    },
    error: function(XMLHttpRequest, textStatus, errorThrown) {

      alert("some error " + String(errorThrown) + String(textStatus) + String(XMLHttpRequest.responseText));
    }
  });

} else {

  $.ajax({
    type : "PUT",
    url : window.APIUpdateURL,
    csrfmiddlewaretoken: "{{ csrf_token }}",
    data : JSON.stringify({game:scenes, id:window.game_id}),
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    success: function(data){
        // console.log(data["id"])
        // window.game_id = data["id"]
        // console.log(data)
        alert("Updated! It worked.");
    },
    error: function(XMLHttpRequest, textStatus, errorThrown) {
      alert("some error " + String(errorThrown) + String(textStatus) + String(XMLHttpRequest.responseText));
      }
    });
  }

});

$('#start_btn').focus();
var blockInfoModal = document.getElementById('blockInfoModal');
var blockInfospan = document.getElementById("blockInfoclose");

var modal = document.getElementById('myModal');
var span = document.getElementById("myModalclose");

var showBlockInfoModal = function() {
    blockInfoModal.style.display = "block";
}
span.onclick = function() {
    blockInfoModal.style.display = "none";
}
window.onclick = function(event) {
    if (event.target == blockInfoModal) {
        blockInfoModal.style.display = "none";
    }
}



var showModal = function() {
    modal.style.display = "block";
}
span.onclick = function() {
    modal.style.display = "none";
}
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

</script>

</div>
</body>

</html>
